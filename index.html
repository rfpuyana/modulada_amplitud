<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <!-- ESTA LINEA ES CLAVE PARA QUE FUNCIONE EN MOBILES -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!--  -->
  <title>MODULADA AMPLITUD</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js"></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />

  <script src='https://npmcdn.com/csv2geojson@latest/csv2geojson.js'></script>
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    /* Popup styling */

    .mapboxgl-popup {
      padding-bottom: 5px;
    }

    .mapboxgl-popup-close-button {
      display: none;
    }

    .mapboxgl-popup-content {
      font: 400 15px/22px 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
      padding: 0;
      width: 250px;
      height: 350px;
    }

    .mapboxgl-popup-content-wrapper {
      padding: 1%;
    }

    .mapboxgl-popup-content h3 {
      /* background: rgb(61, 59, 59); */
      text-align: center;
      color: #FF00CC;
      margin: 0;
      display: block;
      padding: 15px;
      font-weight: 700;
      margin-top: -5px;
    }

    .mapboxgl-popup-content h4 {
      margin: 0;
      display: block;
      padding: 10px 3px 10px 10px;
      font-weight: 400;
    }

    .mapboxgl-container {
      cursor: pointer;
    }

    .mapboxgl-popup-anchor-top>.mapboxgl-popup-content {
      margin-top: 3px;
    }

    .mapboxgl-popup-anchor-top>.mapboxgl-popup-tip {
      border-bottom-color: rgb(61, 59, 59);
    }
    /* !_! overlay */
    #overlay {
      display: none;
      background-image: url("https://f4.bcbits.com/img/a1254629576_16.jpg");
      /* background: blue; */
      opacity: 1;
      position: absolute;
      float: left;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 200;
      width: 350px;
      height:442px;
    }
    #iframeId {
      z-index: 100;
    }
  </style>
</head>

<body>

  <!-- !_!  popup externo a mapbox-->
  <div id="overlay">
        <div id = "iframeId">
          <iframe style="border: 0; width: 350px; height: 442px;" src="https://bandcamp.com/EmbeddedPlayer/track=1685839261/size=large/bgcol=ffffff/linkcol=e99708/tracklist=false/transparent=false/" seamless><a href="https://rafapuyana.bandcamp.com/track/los-barrios-peligrosos">Los Barrios Peligrosos by Rafa Puyana</a></iframe>
        </div>
  </div>

  <div id='map'></div>
  <script>
     // !_! Rafa
     // Esta funcion hace flyTo a un punto al azar. Estos puntos estan creados y cargados abajo
    var CargarRandomPoint = (map,data) => {
        NumeroRandom = Math.floor(Math.random()*data['features'].length)
        coordinates=data['features'][NumeroRandom]['geometry']['coordinates']
        zoom = data['features'][NumeroRandom]['properties']['zoom']
        map.flyTo({center: coordinates, zoom: 90});
    }
   // !_! Overlay JS

   function OverlayOn() {
     document.getElementById("overlay").style.display = "block";
     // document.getElementById("art").style.display = "block";
   }

   function OverlayOff() {
     document.getElementById("overlay").style.display = "none";
   }

    var transformRequest = (url, resourceType) => {
      var isMapboxRequest =
        url.slice(8, 22) === "api.mapbox.com" ||
        url.slice(10, 26) === "tiles.mapbox.com";
      return {
        url: isMapboxRequest
          ? url.replace("?", "?pluginName=sheetMapper&")
          : url
      };
    };
    // YOUR TURN:
    mapboxgl.accessToken = 'pk.eyJ1IjoicmZwdXlhbmEiLCJhIjoiY2trenplcmd6MDd2cTJvcnhxdWV6MnN0MiJ9.CNMZ9ikFZOe4-EDjtjinBw'; //Mapbox token
    var map = new mapboxgl.Map({
      container: 'map', // container id
      style: 'mapbox://styles/mapbox/dark-v10', // YOUR TURN: choose a style: https://docs.mapbox.com/api/maps/#styles
      // https://www.google.com/maps/place/Quebrada+las+Delicias/@4.6365348,-74.0560484,16
      center: [4.6365348,-74.0560484], // starting position [lng, lat]
      zoom: 1,// starting zoom
      transformRequest: transformRequest
    });

    $(document).ready(function () {
      $.ajax({
        type: "GET",
        //YOUR TURN: Replace with csv export link
        url: 'https://docs.google.com/spreadsheets/d/1nJeCdVvaIFnmTGz_bcZfD69PLP3uG4V_Ed16dFo5-hs/gviz/tq?tqx=out:csv&sheet=ASIA-EUR',
        dataType: "text",
        success: function (csvData) { makeGeoJSON(csvData); }
      });



      function makeGeoJSON(csvData) {
        csv2geojson.csv2geojson(csvData, {
          latfield: 'Latitude',
          lonfield: 'Longitude',
          delimiter: ','
        }, function (err, data) {
          map.on('load', function () {

            // !_!
            // console.log(data)
            //Add the the layer to the map
            map.addLayer({
              'id': 'csvData',
              'type': 'circle',
              'source': {
                'type': 'geojson',
                'data': data
              },
              'paint': {
                'circle-radius': 20,
                'circle-color': "white"
              }
            });
            //
            var NumeroRandom = Math.floor(Math.random()*data['features'].length)
            var coordinates=data['features'][NumeroRandom]['geometry']['coordinates']
            var zoom = data['features'][NumeroRandom]['properties']['zoom']
            map.flyTo({center: coordinates, zoom: 90});
            // CargarRandomPoint(map,data);
            //
            map.addControl(new mapboxgl.NavigationControl());

            // When a click event occurs on a feature in the csvData layer, open a popup at the
            // location of the feature, with description HTML from its properties.
            map.on('click', 'csvData', function (e) {
              OverlayOn();
              var coordinates = e.features[0].geometry.coordinates.slice();
              // // !_! Este JumpTp lo Met√≠ para que se mueva un poco hacia arriba y se vea en mobile
              // BORRAR CANTIDATE
              // map.jumpTo({
              //   center: [coordinates[0],coordinates[1]-0.0008],
              // });
              //set popup text
              //You can adjust the values of the popup to match the headers of your CSV.
              // For example: e.features[0].properties.Name is retrieving information from the field Name in the original CSV.

              // var description = e.features[0].properties.EmbedCode

              // var description ='<iframe width="100%" height="300" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/'+e.features[0].properties.EmbedCode+'&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true"></iframe><div style="font-size: 10px; color: #cccccc;line-break: anywhere;word-break: normal;overflow: hidden;white-space: nowrap;text-overflow: ellipsis; font-family: Interstate,Lucida Grande,Lucida Sans Unicode,Lucida Sans,Garuda,Verdana,Tahoma,sans-serif;font-weight: 100;"></div>'

              // var description = '<iframe style="border: 0; width: 100%; height: 350px;" src="https://bandcamp.com/EmbeddedPlayer/track=1685839261/size=large/bgcol=ffffff/linkcol=0687f5/tracklist=false/transparent=true/" seamless><a href="https://rafapuyana.bandcamp.com/track/barrios-peligrosos">Barrios Peligrosos by Rafa Puyana</a></iframe>'

               // console.log(coordinates)
               // console.log(e.features[0].properties.EmbedCode)
               // console.log(e.features[0].properties.Name)
               // console.log(e.features[0].properties.Latitude)
               // console.log(e.features[0].properties.Longitude)

              // var description = `<h3>` + e.features[0].properties.Name + `</h3>` + `<h4>` + `<b>` + `Address: ` + `</b>` + e.features[0].properties.Address + `</h4>` + `<h4>` + `<b>` + `Phone: ` + `</b>` + e.features[0].properties.Phone + `</h4>`;
              // var description =
              // Ensure that if the map is zoomed out such that multiple
              // copies of the feature are visible, the popup appears
              // over the copy being pointed to.
              // while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
              //   coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
              // }

              //add Popup to map

              // new mapboxgl.Popup()
              //   .setLngLat(coordinates)
              //   .setHTML(description)
              //   .addTo(map);
              });

              // Change the cursor to a pointer when the mouse is over the places layer.
              map.on('mouseenter', 'csvData', function () {
                map.getCanvas().style.cursor = 'pointer';
              });

              // Change it back to a pointer when it leaves.
              map.on('mouseleave', 'places', function () {
                map.getCanvas().style.cursor = '';
              });

              var bbox = turf.bbox(data);
              // map.fitBounds(bbox, { padding: 50 });
          });
        });
      };
    });
  </script>
</body>
</html>
